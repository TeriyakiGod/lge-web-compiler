//32x8
char wall1[] = {0xbb,0xbb,0xbc,0xbb,0xbb,0xbc,0xbb,0xbc,0xbb,0xbb,0xbc,0xbb,0xbb,0xcb,0xbb,0xbc,0xbb,0xbb,0xbb,0xcb,0xbc,0xbc,0xbb,0xbb,0xcb,0xbb,0xcb,0xcc,0xbc,0xbc,0xbb,0xcc,0xcb,0xbb,0xbb,0xbc,0xcb,0xcb,0xbb,0xbb,0xbc,0xbc,0xbb,0xbb,0xcb,0xbb,0xcc,0xbb,0xbc,0xbb,0xbb,0xcb,0xbb,0xbc,0xbb,0xbc,0xcb,0xcb,0xbb,0xbb,0xcb,0xbb,0xcb,0xbb,0xcc,0xcc,0xbc,0xcb,0xbb,0xbb,0xcb,0xbc,0xbb,0xbc,0xbb,0xbb,0xcb,0xbc,0xbc,0xbb,0xbb,0xbb,0xcb,0xbb,0xbb,0xbc,0xbc,0xbc,0xbb,0xbb,0xcb,0xbc,0xbc,0xcb,0xbb,0xcc,0xbb,0xbc,0xbb,0xbb,0xbb,0xcb,0xbc,0xcb,0xbb,0xbb,0xbc,0xcb,0xbb,0xbb,0xbb,0xbc,0xbb,0xbb,0xcb,0xbb,0xbb,0xcb,0xbb,0xbc,0xbb,0xbb,0xbb,0xcb,0xbb,0xbb,0xbb,0xcb};
//128x8 rle
char wall2l[] = {0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99,0x3d,0x88,0x82,0xcc,0x2,0x99};
char wall2r[] = {0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88,0x2,0x99,0x82,0xcc,0x3d,0x88};
//6x12
char ship[] = {0x0,0x55,0x0,0x5,0x55,0x50,0x5,0x33,0x50,0x5,0x33,0x50,0x5,0x55,0x50,0x5,0x55,0x50,0x5,0x55,0x50,0x5,0x55,0x50,0x5,0x55,0x50,0x95,0x99,0x59,0x55,0x99,0x55,0x55,0x99,0x55};
//128x128
char intro1[] = {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0xb0,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0xb0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x2,0xbb,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x90,0x0,0x0,0xb,0x2b,0x20,0x0,0x9,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xb,0x2b,0x20,0x20,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2b,0x2b,0xb0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x22,0xb0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x90,0x2,0xb2,0xb0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0xb2,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x0,0x2,0x22,0x20,0x9,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0xb2,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0xbb,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x82,0x2b,0x2a,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x8,0xaa,0xa2,0xaa,0xc0,0x60,0x60,0x60,0x60,0x60,0x66,0x66,0x66,0x66,0x66,0x66,0x68,0xaa,0x2a,0x2a,0xc6,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x8a,0xaa,0x2a,0xa2,0xac,0x66,0x66,0x66,0x66,0x66,0x63,0x63,0x63,0x63,0x63,0x68,0xa8,0xa2,0xaa,0xa2,0xaa,0xc3,0x63,0x63,0x63,0x63,0x33,0x33,0x33,0x33,0x33,0x8a,0x8a,0x2a,0x2a,0xaa,0x2c,0xac,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x38,0xa8,0xa2,0xaa,0xaa,0xaa,0xaa,0xca,0xc3,0x33,0x33,0x33,0x7a,0x7a,0x7a,0xaa,0x8a,0x8a,0xaa,0xaa,0xaa,0xac,0xaa,0xac,0xac,0xaa,0xaa,0xaa,0xa7,0xaa,0xa8,0xa8,0xa8,0xa8,0xaa,0xaa,0xaa,0xaa,0xca,0xaa,0xca,0xca,0xaa,0xca,0x7a,0xa8,0xa8,0x8a,0x8a,0x8a,0xaa,0xaa,0xaa,0xac,0xaa,0xaa,0xac,0xac,0xaa,0xac,0xaa,0x8a,0x88,0xa8,0xa8,0xaa,0xaa,0xaa,0xaa,0xaa,0xca,0xaa,0xca,0xca,0xcc,0xaa,0xaa,0xaa,0xaa,0x8a,0x8a,0x8a,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xac,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xa8,0xa8,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xca,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x7a,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xa7,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0x7a,0x7a,0x7a,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xac,0xac,0xa7,0xa7,0xa7,0xa7,0xa7,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xca,0xca,0xca,0x7a,0x7a,0x7a,0x7a,0x7a,0x7a,0x7a,0x7a,0xaa,0xaa,0xaa,0xac,0xac,0xac,0xac,0xac,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa};
char intro2[] = {0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xcc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbc,0xcc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbc,0xcc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbc,0xcc,0xbb,0xbc,0xcc,0xcb,0xcb,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xcc,0xbc,0xbc,0xbc,0xbc,0xcc,0xcc,0xcc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xcb,0xcb,0xcb,0xcb,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbc,0xbc,0xbc,0xbb,0xcc,0xcc,0xcc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xcb,0xbb,0xcb,0xcb,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbc,0xbc,0xbc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xb5,0x55,0xbb,0xbb,0xcb,0xcb,0xbb,0xbb,0xbb,0xbc,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0x55,0x55,0x5b,0xbb,0xbc,0xcc,0xbb,0xbb,0xbc,0xcc,0xbc,0xbb,0xbb,0xbb,0xbb,0xb5,0x55,0x55,0x5b,0xbb,0xbb,0xbc,0xbb,0xbb,0xbb,0xcb,0xcb,0xcb,0xbb,0xbb,0xb6,0x55,0x5e,0x55,0x5b,0xbb,0xbb,0xcc,0xbb,0xbb,0xbb,0xbc,0xbc,0xcc,0xbb,0xb6,0x65,0x55,0x5e,0xee,0x5b,0xbb,0xbc,0xbc,0xbb,0xbb,0xbb,0xbb,0xbb,0xcc,0xbb,0xb6,0x65,0x55,0x55,0xee,0x5b,0xbb,0xbb,0xcc,0xcb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x55,0x55,0x55,0x55,0xbb,0xbb,0xbb,0xbb,0xcb,0xbb,0xb2,0xbb,0xbb,0xbc,0xbb,0xab,0x55,0x55,0x55,0x5b,0xbb,0xbb,0xbb,0xbb,0xcc,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xb5,0x56,0x55,0x56,0xbb,0xbb,0xbb,0xbb,0xbc,0xbb,0xbb,0xbb,0x2b,0xbb,0xbb,0xab,0xb6,0x65,0x55,0x66,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xab,0x2b,0xbb,0xbb,0xbb,0xb6,0x6b,0xbb,0x66,0xbb,0xcb,0xbc,0xcc,0xcb,0xbb,0xba,0xbb,0xbb,0xab,0xbb,0xb2,0xbb,0xbb,0xba,0xbb,0xbb,0xbc,0xcb,0xcb,0xcc,0xcb,0x22,0x22,0x2b,0xbb,0xbb,0x2b,0xbb,0xba,0xbb,0xbb,0xbb,0xbc,0xbc,0xbb,0xbb,0xbb,0x22,0x22,0x22,0x2a,0x22,0xbb,0xbb,0xbb,0xbb,0xab,0xbb,0xcb,0xcb,0xbb,0xbb,0xbb,0x22,0x22,0xa2,0x22,0x22,0x2b,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0xab,0xbb,0xbb,0xbb,0xbb,0xcc,0xcb,0xbb,0xbb,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x2b,0xbb,0xbb,0x2b,0xbb,0xbb,0xbc,0xcb,0xbb,0x22,0x22,0x22,0x22,0x22,0x2a,0x22,0x22,0xba,0xbb,0xbb,0xbb,0xbb,0xbb,0xcc,0xbb,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x2b,0xbb,0xbb,0xbb,0xbb,0xbb,0xbc,0xbb,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x2b,0xab,0x2b,0xbb,0x2b,0xbb,0xbc,0xbb,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0xb2,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x2b,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb};
int intro[] = {intro1,0,0,intro2,0};
char field[272];
char buf_field[256];
int colors[] = {11, 11, 12, 15, 15, 7, 7, 10, 10, 10, 10, 2, 2, 2, 2};

int x,y,xpos,ypos,t,angle,dir,key,wleft,wright,length,left,test;

void init(){
	int i;
	setbgcolor(0);
	loadtile(intro, 32, 32, 4, 1);
	drawtile(48, 32);
	gotoxy(4, 12);
	printf("press any key");
	settimer(1, 1000);
	while(gettimer(1)){}
	while(!getkey()){}
	gotoxy(4, 12);
	printf("\n");
	for(i = 0; i < 12; i++){
		scroll(2);
		scroll(2);
		scroll(2);
		scroll(2);
		delayredraw();
	}
	gotoxy(2, 10);
	printf("You explored the depths of Olympus Mons Volcano when the eruption began. Hurry to fly away.");
	while(!getkey()){}
	setbgcolor(11);
	clearscreen();
	for(i = 0; i < 128; i++){
		field[i] = random(14);
	}
	for(x = 0; x < 4; x++){
		for(y = 0; y < 16; y++){
			putimage(wall1, x * 32, y * 8, 32, 8);
		}
	}
	getsprite(1, ship);
	spritesetvalue(1, S_IS_SCROLLED, 0);
	spritesetvalue(1, S_WIDTH, 6);
	spritesetvalue(1, S_HEIGHT, 12);
	putsprite(1, 61, 50);
	setparticle(1, 16, 2000);			
	setemitter(50, 60, 120, 20);
	emittersize(1, 4, 1);
	xpos = 63;
	wleft = 0;
	wright = 127;
	length = 64;
}

void draw(){
	int c, i;
	scroll(3);
	scroll(3);
	ypos += 2;
	t++;
	for(i = 0; i < 4; i++){
		putimage(wall1, i * 32, ypos % 8 - 6, 32, 8);
	}
	putimagerle(wall2r, wright, 0, 128, 8);
	putimagerle(wall2l, wleft - 128, 0, 128, 8);
	i = 64;
	for(y = 4; y < 18; y++){
		for(x = 0; x < 16; x++){
			i++;
			field[i] = buf_field[i];
			if(y > 8 && (t & 1) == (x & 1)){
				setcolor(colors[field[i]]);
				fillcircle(x * 4, y * 4 + 64 + x - 6, 1 + random(2));
				fillcircle(x * 4 + 64, y * 4 + 64 - x + 6, 1 + random(2));
			}
		}
	}
	spritesetvalue(1, S_ANGLE, angle); 
	spritesetvalue(1, S_X, xpos);
	setemitter(50, 60 + angle, 120 + angle, 20);
	drawparticle((xpos + 2) - angle / 4, 64, random(1)?2:7);
	delayredraw();
}

void step(){
	int i;
	if(!gettimer(1)){
		settimer(1, 3000);
		length = 24 + random(56);
		left = 8 + random(40);
	}
	for(i = 240; i < 272; i++)
		field[i] = 10 + random(4);
	for(i = 0; i < 256; i++){
		if(field[i] == field[i + 16]){
			buf_field[i] = 0;
		}
		else{
			buf_field[i] = ((field[i] + field[i + 16]) / 2);
		}
	}
	if(dir){
		angle++;
		xpos += 2;
	}
	else{
		angle--;
		xpos -= 2;
	}
	if(getkey()){
		if(!key){
			dir = 1 - dir;
			key = 1;
			angle = 0;
		}
	}
	else{
		key = 0;
	}
	if(wright - wleft >= length){
		wright--;
		wleft++;
	}
	else{
		wright++;
		wleft--;
	}
	if(left > wleft){
		wright++;
		wleft++;
	}
	else{
		wright--;
		wleft--;
	}
	if(getpixel(xpos - 2, 50) == 9 || getpixel(xpos - 2, 51) == 9) {
		dir = 1;
		angle = 20;
		xpos += 2;
	}
	if(getpixel(xpos + 8, 50) == 9 || getpixel(xpos + 8, 51) == 9) {
		dir = 0;
		angle = -20;
		xpos -= 2;
	}
}

void main(){
	init();
	while(1){
		step();
		draw();
	}
}