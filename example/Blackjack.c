/*settings*{"name":"blackjack","author":"corax","image":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,204,204,204,204,0,0,0,0,0,0,12,193,17,17,17,17,0,0,0,0,0,12,193,193,17,17,17,17,0,0,0,0,12,193,17,28,17,27,17,17,0,0,0,12,193,17,17,28,17,187,177,17,0,0,12,193,17,17,17,17,203,187,187,17,0,0,12,17,17,17,17,17,203,187,187,17,0,0,0,193,17,17,34,33,28,27,17,17,0,0,0,193,17,17,34,33,28,187,177,17,0,0,0,12,17,34,34,33,17,193,17,17,0,0,0,12,17,34,34,33,17,193,17,17,0,0,0,0,193,34,34,33,17,28,17,17,0,0,0,0,193,17,17,17,17,28,17,17,0,0,0,0,12,17,17,17,17,17,193,17,0,0,0,0,12,17,17,17,17,17,193,17]}*/
//16x24
char shirt[]  = {0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc1,0x81,0x81,0x81,0x81,0x81,0x81,0x8c,0xc8,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0};
char spades[] = {0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x1b,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0xbb,0xb1,0x11,0x11,0x1c,0xc1,0x11,0x1b,0xbb,0xbb,0x11,0x11,0x1c,0xc1,0x11,0xbb,0xbb,0xbb,0xb1,0x11,0x1c,0xc1,0x11,0xbb,0xbb,0xbb,0xb1,0x11,0x1c,0xc1,0x11,0x11,0x1b,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x1b,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0xbb,0xb1,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0};
char clubs[]  = {0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0xbb,0xb1,0x11,0x11,0x1c,0xc1,0x11,0x1b,0xbb,0xbb,0x11,0x11,0x1c,0xc1,0x11,0x1b,0xbb,0xbb,0x11,0x11,0x1c,0xc1,0x11,0x11,0xbb,0xb1,0x11,0x11,0x1c,0xc1,0x1b,0xb1,0x1b,0x11,0xbb,0x11,0x1c,0xc1,0xbb,0xbb,0xbb,0xbb,0xbb,0xb1,0x1c,0xc1,0xbb,0xbb,0x1b,0x1b,0xbb,0xb1,0x1c,0xc1,0x1b,0xb1,0x1b,0x11,0xbb,0x11,0x1c,0xc1,0x11,0x11,0x1b,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0xbb,0xb1,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0};
char hearts[] = {0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x12,0x11,0x12,0x11,0x11,0x1c,0xc1,0x11,0x22,0x21,0x22,0x21,0x11,0x1c,0xc1,0x12,0x22,0x22,0x22,0x22,0x11,0x1c,0xc1,0x12,0x22,0x22,0x22,0x22,0x11,0x1c,0xc1,0x12,0x22,0x22,0x22,0x22,0x11,0x1c,0xc1,0x12,0x22,0x22,0x22,0x22,0x11,0x1c,0xc1,0x11,0x22,0x22,0x22,0x21,0x11,0x1c,0xc1,0x11,0x12,0x22,0x22,0x11,0x11,0x1c,0xc1,0x11,0x11,0x22,0x21,0x11,0x11,0x1c,0xc1,0x11,0x11,0x12,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0};
char diamonds[] = {0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x12,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x22,0x21,0x11,0x11,0x1c,0xc1,0x11,0x12,0x22,0x22,0x11,0x11,0x1c,0xc1,0x11,0x22,0x22,0x22,0x21,0x11,0x1c,0xc1,0x12,0x22,0x22,0x22,0x22,0x11,0x1c,0xc1,0x11,0x22,0x22,0x22,0x21,0x11,0x1c,0xc1,0x11,0x12,0x22,0x22,0x11,0x11,0x1c,0xc1,0x11,0x11,0x22,0x21,0x11,0x11,0x1c,0xc1,0x11,0x11,0x12,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc1,0x11,0x11,0x11,0x11,0x11,0x11,0x1c,0xc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xc0};
//4x65
char cardvalues[] = {0xbb,0xb0,0x0,0xb0,0xbb,0xb0,0xb0,0x0,0xbb,0xb0,0xbb,0xb0,0x0,0xb0,0xb,0xb0,0x0,0xb0,0xbb,0xb0,0xb0,0xb0,0xb0,0xb0,0xbb,0xb0,0x0,0xb0,0x0,0xb0,0xbb,0xb0,0xb0,0x0,0xbb,0xb0,0x0,0xb0,0xbb,0xb0,0xbb,0xb0,0xb0,0x0,0xbb,0xb0,0xb0,0xb0,0xbb,0xb0,0xbb,0xb0,0x0,0xb0,0x0,0xb0,0x0,0xb0,0x0,0xb0,0xbb,0xb0,0xb0,0xb0,0xbb,0xb0,0xb0,0xb0,0xbb,0xb0,0xbb,0xb0,0xb0,0xb0,0xbb,0xb0,0x0,0xb0,0xbb,0xb0,0xb0,0xbb,0xb0,0xbb,0xb0,0xbb,0xb0,0xbb,0xb0,0xbb,0x0,0xb0,0x0,0xb0,0x0,0xb0,0xb0,0xb0,0xb,0x0,0xbb,0xb0,0xb0,0xb0,0xb0,0xb0,0xbb,0x0,0x0,0xb0,0xb0,0xb0,0xb0,0xb0,0xbb,0x0,0xb0,0xb0,0xb0,0xb0,0xb,0x0,0xb0,0xb0,0xbb,0xb0,0xb0,0xb0,0xb0,0xb0};
int cards[52];

char winsnd[] = "De:d=4,o=5,b=200:g,8f,8b,a,b,p";
char loossnd[] = "De:d=4,o=5,b=200:2p,b,a,f,c,a";

int position,money,rate,scorep,scored,ingame,drawposition,drawpositiond,key,prevkey;
int acecountp,acecountd,dillersecondcard,record;

void drawCard(int n, int x, int y){
	int c;	
	switch(n / 13){
		case 0:
			putimage(spades, x, y, 16, 24);
			break;
		case 1:
			putimage(clubs, x, y, 16, 24);
			break;
		case 2:
			putimage(hearts, x, y, 16, 24);
			break;
		case 3:
			putimage(diamonds, x, y, 16, 24);
			break;
	}
	c = (n % 13) * 10;
	putimage(cardvalues + c, x + 2, y + 2, 4, 5);
	putimage(cardvalues + c, x + 11, y + 17, 4, 5);
	tone(30,300);
}

void delay(int time){
	settimer(0, time);
	while(gettimer(0)){}
}

void shuffleCards(){
	int i,c,r;
	clearscreen();
	position = 0;
	for(i = 0; i < 52; i++){
		r = random(51);
		c = cards[i];
		cards[i] = cards[r];
		cards[r] = c;
	}
	for(i = 9; i >= 0; i--){
		putimage(shirt, 20 + i * 6, 50, 16, 24);
		delay(100);
	}
	for(i = 0; i < 10; i++){
		putimage(shirt, 20 + i * 6, 50, 16, 24);
		delay(100);
	}
	setcolor(0);
	for(i = 54; i >= 0; i--){
		putimage(shirt, 20 + i, 50, 16, 24);
		line(37 + i, 50, 37 + i, 74);
		delay(10);
	}
}

void addPlayerScore(int n){
	int c;
	c = n % 13;
	if(c < 9){
		scorep = scorep + c + 2;
	}
	else if (c < 12){
		scorep = scorep + 10;
	}
	else{
		scorep = scorep + 11;
		acecountp++;
	}
	if(scorep > 21){
		if(drawposition == 0 && acecountp == 2 && scorep == 22){
			scorep = 21;
			acecountp = 0;
		}
		if(acecountp > 0){
			scorep = scorep - 10;
			acecountp--;
		}
		if(scorep > 21)
			ingame = 0;
	}
	if(scorep == 21)
		ingame = 0;
	setcolor(1);
	gotoxy(2,10);
	printf("%d",scorep);
}

void addDillerScore(int n){
	int c;
	c = n % 13;
	if(c < 9){
		scored = scored + c + 2;
	}
	else if (c < 12){
		scored = scored + 10;
	}
	else{
		scored = scored + 11;
		acecountd++;
	}
	if(scored > 21){
		if(drawpositiond == 0  && acecountd == 2 && scored == 22){
			scored = 21;
			acecountd = 0;
		}
		if(acecountd > 0){
			scored = scored - 10;
			acecountd--;
		}
		if(scored > 21)
			ingame = 0;
	}
	setcolor(1);
	gotoxy(2,5);
	printf("%d",scored);
}

void startGame(){
	clearscreen();
	putimage(shirt, 20, 50, 16, 24);
	scorep = 0;
	scored = 0;
	acecountp = 0;
	acecountd = 0;
	key = 0;
	putimage(shirt, 30, 10, 16, 24);
	delay(50);
	putimage(shirt, 10, 10, 16, 24);
	delay(50);
	putimage(shirt, 30, 90, 16, 24);
	delay(50);
	putimage(shirt, 10, 90, 16, 24);
	delay(50);
	dillersecondcard = position++;
	addDillerScore(cards[position]);
	drawCard(cards[position++],10,10);
	addPlayerScore(cards[position]);
	drawCard(cards[position++],30,90);
	addPlayerScore(cards[position]);
	drawCard(cards[position++],10,90);
	gotoxy(7,5);
	printf("rate %d$  ", rate);
	gotoxy(7,7);
	printf("A - add card");
	gotoxy(7,8);
	printf("B - finish");
}

void init(){
	int i;
	for(i = 0; i < 52; i++)
		cards[i] = i;
	shuffleCards();
	money = 100;
	rate = 1;
	setcolor(1);
	record = 0;
	loaddata("blackjack",&record);
	if(record < 100)
		record = 100;
}

void addCard(){
	addPlayerScore(cards[position]);
	if(drawposition < 3)
		drawCard(cards[position++],50 + drawposition * 18,90);
	else
		drawCard(cards[position++],76 + drawposition * 6,90);
	drawposition++;
}

void gameLoop(){
	ingame = 1;
	drawposition = 0;
	while(ingame){
		while(key == prevkey)
			key = getkey();
		prevkey = key;
		if(key & KEY_A)
			addCard();
		if(key & KEY_B)
			ingame = 0;
	}
}

void dillerPlay(){
	drawpositiond = 0;
	addDillerScore(cards[dillersecondcard]);
	drawCard(cards[dillersecondcard],30,10);
	ingame = 1;
	if(scorep > 21)
		ingame = 0;
	while(ingame){
		delay(400);
		if(scored < scorep || (scored == scorep && scored < 17)){
			addDillerScore(cards[position]);
			if(drawpositiond < 3)
				drawCard(cards[position++],50 + drawpositiond * 18,10);
			else
				drawCard(cards[position++],76 + drawpositiond * 6,10);
			drawpositiond++;
		}	
		else
			ingame = 0;
	}
}

void changeRate(){
	key = 0;
	gotoxy(7,6);
	printf("money %d$   ", money);
	gotoxy(7,9);
	printf("You record");
	gotoxy(7,10);
	printf("%d$   ", record);
	while(key == 0){
		key = getkey();
		if(key & KEY_UP){
			if(rate < 10)
				rate++;
			delay(200);
			key = 0;
		}
		if(key & KEY_DOWN){
			if(rate > 1)
				rate--;
			delay(200);
			key = 0;
		}
		gotoxy(7,5);
		printf("rate %d$  ", rate);
	}
}

void changeMoney(){
	gotoxy(7,9);
	if(scorep == scored){
		printf("draw");
	}
	else if(scorep < 22 && (scorep > scored || scored > 21)){
		money = money + rate;
		printf("you win");
		loadrtttl(winsnd, 0);
		playrtttl();
	}
	else{
		money = money - rate;
		printf("diller win");
		loadrtttl(loossnd, 0);
		playrtttl();
	}
	delay(1000);
	changeRate();
	if(money > record){
		record = money;
		savedata("blackjack",&record,2);
	}
}

void main(){
	init();
	changeRate();
	while(money){
		startGame();
		gotoxy(7,6);
		printf("money %d$   ", money);
		gameLoop();
		dillerPlay();
		changeMoney();
		if(position > 36)
			shuffleCards();
	}
}